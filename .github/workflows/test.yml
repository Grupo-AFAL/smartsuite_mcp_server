name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Run tests with coverage
        run: bundle exec rake test

      - name: Report coverage
        run: |
          if [ -f coverage/.last_run.json ]; then
            COVERAGE=$(ruby -r json -e 'puts JSON.parse(File.read("coverage/.last_run.json"))["result"]["line"]')
            echo "üìä Code Coverage: ${COVERAGE}%"
            echo "üéØ Target: 90%"
            GAP=$(echo "90 - $COVERAGE" | bc)
            echo "üìà Gap: ${GAP}%"

            # Baseline: 82.77% (current coverage after v1.8 test improvements)
            # Don't fail build, just report status
            if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
              echo "üéâ Excellent coverage!"
            elif (( $(echo "$COVERAGE >= 82.77" | bc -l) )); then
              echo "‚úÖ Good coverage - at or above baseline"
            elif (( $(echo "$COVERAGE >= 75" | bc -l) )); then
              echo "‚ö†Ô∏è  Coverage acceptable but below baseline (82.77%)"
            else
              echo "‚ùå Coverage significantly below baseline (82.77%)"
            fi
          else
            echo "‚ö†Ô∏è  No coverage report found"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
